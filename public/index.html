<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoShopper</title>

    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Train+One&display=swap');
    </style>
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <header class="topnav" v-if="!isLoginPage">
            <!-- Logo -->
            <a href="#">
                <img src="http://localhost:5500/images/EcoShopperLogo.png" id="logo" alt="Logo"
                    @click="toLandingPage" />
            </a>

            <!-- Search Container -->
            <div class="search-container">
                <form @submit.prevent="searchProducts">
                    <input type="text" v-model="searchQuery" placeholder="Search products..." name="search"
                        style="padding: 10px 20px" @input="debouncedSearch" />
                    <button type="submit" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>

            <!-- Light/Dark Mode Toggle -->
            <button @click="toggleTheme" class="theme-toggle" :class="{ 'dark-mode': isDarkMode }">
                <i class="fas" :class="isDarkMode ? 'fa-moon' : 'fa-sun'"></i>
            </button>

            <!-- Cart Button -->
            <button @click="showCheckout" class="cart-button" :class="{ 'on-checkout': checkoutPage }"
                :data-tooltip="checkoutPage ? 'Back to Shopping' : 'View Cart'">
                <span class="fas fa-cart-plus"></span>
                <sup>{{ cartItemCount }}</sup>
            </button>
            <button @click="showStats" class="stats-button" title="View Your Impact" v-if="isAuthenticated">
                <span class="fas fa-leaf"></span>
                <sup>{{ userStats.ecoPoints }}</sup>
            </button>
            <!-- Login Button -->
            <!-- Show either Login or Logout button based on authentication status -->
            <button v-if="!isAuthenticated" @click="goToLogin" class="login-button">Login</button>
            <button v-else @click="logout" class="login-button">Logout</button>

        </header>

        <!-- Login And Sign Up forms -->
        <div class="container" v-if="isLoginPage">
            <input type="checkbox" id="flip">
            <div class="cover">
                <div class="front">
                    <img src="http://localhost:5500/images/frontImg.jpg" alt="">
                    <div class="text">
                        <span class="text-1">Every new friend is a <br> new adventure</span>
                        <span class="text-2">Let's get connected</span>
                    </div>
                </div>
                <div class="back">
                    <img class="backImg" src="http://localhost:5500/images/backImg.jpg" alt="">
                    <div class="text">
                        <span class="text-1">Complete miles of journey <br> with one step</span>
                        <span class="text-2">Let's get started</span>
                    </div>
                </div>
            </div>

            <div class="forms">
                <div class="form-content">
                    <!-- Login Form -->
                    <div class="login-form">
                        <div class="title">Login</div>
                        <form @submit.prevent="login">
                            <div class="input-boxes">
                                <div class="input-box">
                                    <i class="fas fa-user"></i>
                                    <input type="text" placeholder="Enter your username" required>
                                </div>
                                <div class="input-box">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" placeholder="Enter your password" required>
                                </div>
                                <div class="button input-box">
                                    <input type="submit" value="Login">
                                </div>
                                <div class="text sign-up-text">Don't have an account? <label for="flip">Signup
                                        now</label></div>
                            </div>
                        </form>
                    </div>

                    <!-- Signup Form -->
                    <div class="signup-form">
                        <div class="title">Signup</div>
                        <form @submit.prevent="signup">
                            <div class="input-boxes">
                                <div class="input-box">
                                    <i class="fas fa-user"></i>
                                    <input type="text" placeholder="Enter your username" required>
                                </div>
                                <div class="input-box">
                                    <i class="fas fa-user"></i>
                                    <input type="email" placeholder="Enter your email" required>
                                </div>
                                <div class="input-box">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" placeholder="Enter your password" required>
                                </div>
                                <div class="input-box">
                                    <i class="fas fa-lock"></i>
                                    <input type="password" placeholder="Confirm your password" required>
                                </div>
                                <div class="button input-box">
                                    <input type="submit" value="Signup">
                                </div>
                                <div class="text sign-up-text">Already have an account? <label for="flip">Login
                                        now</label></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div v-if="isLoginPage">
            <button @click="toLandingPage" id="backHome"> Back to Home</button>
        </div>

        <!-- Custom Alert -->
        <div id="alert-container">
            <div v-for="alert in alerts" :key="alert.id" :class="['alert', `alert-${alert.type}`]">
                <i :class="alert.icon"></i>
                {{ alert.message }}
            </div>
        </div>

        <!-- Landing Page Section -->
        <main class="landing" v-if="!showProducts && !checkoutPage && !showReceipt && !isLoginPage && !showMap">
            <div class="landing-section background-image">
                <div class="text-content">
                    <h2>Welcome to {{ sitename }}!</h2>
                    <p>
                        Discover the best deals from nearby stores in real time!
                        EcoShopper helps you save money while reducing paper waste
                        by bringing live shopping updates straight to your device.
                    </p>
                    <button class="view-products-btn" @click="showNearbyStores">
                        View latest deals around you!
                    </button>
                </div>
            </div>
        </main>

        <main v-if="showMap" class="map-container">
            <div class="map-header">
                <h2>Stores Near You</h2>
                <div class="map-actions">
                    <button @click="centerUserLocation" class="location-btn" title="Center on my location">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                    <button @click="viewProducts" class="view-all-btn">
                        View All Products
                    </button>
                    <button @click="toLandingPage" class="back-btn">
                        Back to Home
                    </button>
                </div>
            </div>
            <div id="storeMap"></div>

            <!-- Store Info Sidebar -->
            <div class="store-sidebar" v-if="selectedStore">
                <div class="store-header">
                    <h3>{{ selectedStore.name }}</h3>
                    <button @click="closeStoreSidebar" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="store-info">
                    <p><i class="fas fa-map-marker-alt"></i> {{ selectedStore.address || 'Address not available' }}</p>
                    <p><i class="fas fa-phone"></i> {{ selectedStore.phone || 'Phone not available' }}</p>
                    <div class="store-distance" v-if="selectedStore.distance">
                        <i class="fas fa-route"></i> {{ (selectedStore.distance / 1000).toFixed(2) }} km away
                    </div>
                </div>
                <div class="store-products">
                    <h4>Available Products</h4>
                    <div v-if="storeProducts.length > 0" class="store-product-list">
                        <div v-for="product in storeProducts" :key="product.id" class="store-product-item">
                            <img :src="product.image" alt="Product Image" class="product-thumbnail">
                            <div class="product-info">
                                <div class="product-name">{{ product.name }}</div>
                                <div class="product-price">{{ product.price }} AED</div>
                            </div>
                            <button @click="addToCart(product)" :disabled="product.availableInventory <= 0"
                                class="add-btn">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div v-else class="no-products">
                        No products available at this store.
                    </div>
                </div>
                <button @click="viewStoreProducts(selectedStore)" class="view-store-products-btn">
                    View All Products at This Store
                </button>
            </div>
        </main>

        <!-- Display products and Sort dropdowns -->
        <main v-if="showProducts && !checkoutPage">
            <div class="sort-section">
                <label for="sort">Sort by:</label>
                <select v-model="sortOption" @change="sortProducts">
                    <option value="name">Name</option>
                    <option value="price">Price</option>
                    <option value="spaces">Availability</option>
                    <option value="category">Category</option>
                </select>
                <label for="order">Order:</label>
                <select v-model="sortOrder" @change="sortProducts">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <div class="active-filter-banner" v-if="activeStoreFilter && showProducts">
                <span>
                    <i class="fas fa-store"></i>
                    Showing products from: {{ stores.find(s => (s._id || s.id) === activeStoreFilter)?.name }}
                </span>
                <button @click="clearStoreFilter" class="clear-filter-btn">
                    <i class="fas fa-times"></i> Show All Products
                </button>
            </div>
            <div class="all-products">
                <div v-for="product in searchResults" :key="product.id" class="product-card">
                    <div class="product-category" v-if="product.category">{{ product.category }}</div>
                    <div class="product-image-container">
                        <img :src="product.image" alt="Product Image" class="product-image">
                    </div>
                    <div class="product-details">
                        <h2 class="product-title">{{ product.name }}</h2>
                        <div class="product-rating" v-if="product.rating">
                            <span v-for="i in 5" :key="i" class="star"
                                :class="{'empty': i > Math.floor(product.rating)}">★</span>
                            <span class="rating-value">({{ product.rating }})</span>
                        </div>
                        <div class="product-price-section">
                            <span class="product-price">{{ product.price }} AED</span>
                            <span class="product-availability"
                                :class="{'out-of-stock': product.availableInventory <= 0}">
                                {{ product.availableInventory > 0 ? 'In Stock' : 'Out of Stock' }}
                            </span>
                        </div>
                        <div class="product-actions">
                            <button @click="addToCart(product)" :disabled="product.availableInventory <= 0"
                                class="add-to-cart-btn">
                                <i class="fas fa-cart-plus"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Checkout Page -->
        <main v-if="checkoutPage">
            <div class="checkout-container">
                <!-- Left Side: Customer Information -->
                <div class="checkout-left form">
                    <h2 style="color: black; margin-bottom: 10px;">Checkout</h2>

                    <div class="label">
                        <span class="title" :class="{ 'focused': order.name }">Name</span>
                        <input id="name" v-model.trim="order.name" @input="validateName"
                            :class="['input-field', { 'invalid': formErrors.name }]" placeholder="Full Name" />
                        <span class="error-message" v-if="formErrors.name">
                            Please enter a valid name (letters only)
                        </span>
                    </div>

                    <div class="label">
                        <span class="title" :class="{ 'focused': order.phone }">Phone</span>
                        <input id="phone" v-model.trim="order.phone" @input="validatePhone"
                            :class="['input-field', { 'invalid': formErrors.phone }]" type="tel"
                            placeholder="Phone Number" />
                        <span class="error-message" v-if="formErrors.phone">
                            Please enter a valid phone number (numbers only)
                        </span>
                    </div>
                </div>

                <!-- Right Side: Cart Details -->
                <div class="checkout-right">
                    <h2>Your Cart ({{ cartItemCount }} items)</h2>
                    <div v-for="product in cartDetails" :key="product.id" class="checkout-product">
                        <img :src="product.image" alt="Product Image" class="cart-image" />
                        <div class="product-info">
                            <span class="product-name">{{ product.name }}</span>
                            <span class="product-price">{{ product.price }} AED </span>
                            <div class="quantity-controls">
                                <span class="quantity-label">Quantity:</span>
                                <button @click="removeFromCart(product)" class="quantity-btn"
                                    :disabled="product.quantity <= 0" style="color:black">
                                    -
                                </button>
                                <span class="quantity-value">{{ product.quantity }}</span>
                                <button @click="addToCart(product)" class="quantity-btn"
                                    :disabled="product.quantity >= originalInventory[product._id || product.id] "
                                    style="color:black">
                                    +
                                </button>
                                <span class="spaces-available">
                                    ({{ originalInventory[product._id || product.id] - cart[product._id || product.id]
                                    || 0 }}
                                    more available)
                                </span>
                            </div>
                            <span class="subtotal">Subtotal: {{ product.quantity * product.price }} AED</span>
                        </div>
                        <button @click="removeFromCart(product)" class="remove-btn">
                            Remove All
                        </button>
                    </div>
                    <div class="cart-total">
                        <p>
                            Total:
                            <span class="price" style="color: black"><b>{{ cartTotal }} AED</b></span>
                        </p>
                    </div>
                    <!-- Place Order Button -->
                    <button class="place-order-btn" v-if="isOrderValid" @click="addOrder"
                        :disabled="cartItemCount === 0">
                        Place Order
                    </button>
                </div>
            </div>

            <!-- Back to products Button -->
            <button class="back-btn" @click="viewProducts">
                <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Back to deals
            </button>


            <!-- Loading Overlay -->
            <div v-if="isLoading" class="loading-overlay">
                <div class="spinner"></div>
                <div class="loading-text">Processing your order...</div>
            </div>
        </main>

        <!-- Receipt (Order Confirmation) -->
        <main v-if="showReceipt" class="receipt-container">
            <div class="receipt">
                <div class="receipt-header">
                    <img src="http://localhost:5500/images/EcoShopperLogo.png" alt="Logo" class="receipt-logo" />
                    <h2>Order Confirmation</h2>
                    <p class="receipt-date">{{ getCurrentDate() }}</p>
                </div>

                <div class="receipt-customer">
                    <h3>Customer Details</h3>
                    <p><strong>Name:</strong> {{ orderDetails.name }}</p>
                    <p><strong>Phone:</strong> {{ orderDetails.phone }}</p>
                    <p><strong>Address:</strong> {{ orderDetails.address }}</p>
                </div>

                <div class="receipt-items">
                    <h3>Order Details</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price (AED)</th>
                                <th>Quantity</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="product in orderDetails.products" :key="product.id">
                                <td>{{ product.name }}</td>
                                <td>{{ product.price }} AED</td>
                                <td>{{ product.quantity }}</td>
                                <td>{{ product.subtotal }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="total-label">Total</td>
                                <td class="total-amount">{{ orderDetails.total }} AED</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="receipt-footer">
                    <p>Your order is confirmed.</p>
                    <p>Thank you for choosing EcoShopper!</p>
                </div>

                <button @click="goToHome" class="home-button">
                    <i class="fas fa-home"></i> Return to Home
                </button>
            </div>
        </main>

        <!-- User Stats Modal -->
        <div class="stats-modal" v-if="showStatsModal">
            <div class="stats-modal-content">
                <div class="stats-header">
                    <h2>Your EcoShopper Impact</h2>
                    <button @click="closeStatsModal" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="impact-stats">
                    <div class="impact-card">
                        <div class="impact-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="impact-data">
                            <h3>Paper Saved</h3>
                            <div class="stat-value">{{ userStats.paperSaved.toFixed(2) }} kg</div>
                            <div class="progress-bar">
                                <div class="progress-fill" :style="{ width: getPaperSavedPercentage + '%' }"></div>
                            </div>
                            <div class="target-info">Target: {{ userStats.paperSavedTarget.toFixed(2) }} kg</div>
                        </div>
                    </div>

                    <div class="impact-card">
                        <div class="impact-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="impact-data">
                            <h3>Eco Purchases</h3>
                            <div class="stat-value">{{ userStats.ecoPurchases }}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" :style="{ width: getEcoPurchasesPercentage + '%' }"></div>
                            </div>
                            <div class="target-info">Target: {{ userStats.purchaseTarget }}</div>
                        </div>
                    </div>

                    <div class="impact-card">
                        <div class="impact-icon">
                            <i class="fas fa-tree"></i>
                        </div>
                        <div class="impact-data">
                            <h3>Trees Saved</h3>
                            <div class="stat-value">{{ getTreesSaved }}</div>
                            <p class="impact-note">Approx. 1 tree saved per 17kg of paper</p>
                        </div>
                    </div>

                    <div class="impact-card">
                        <div class="impact-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="impact-data">
                            <h3>EcoPoints</h3>
                            <div class="stat-value">{{ userStats.ecoPoints }}</div>
                            <p class="impact-note">You're {{ userStats.nextRewardThreshold - userStats.ecoPoints }}
                                points away from your next reward!</p>
                        </div>
                    </div>
                </div>

                <div class="rewards-section">
                    <h3>Your Rewards</h3>
                    <div class="rewards-list">
                        <div v-for="(reward, index) in userStats.rewards" :key="index" class="reward-item" :class="{ 'new': reward.unlocked }">
                            <div class="reward-icon" :class="{ 'unlocked': reward.unlocked }">
                                <i :class="reward.icon"></i>
                            </div>
                            <div class="reward-info">
                                <h4>{{ reward.name }}</h4>
                                <p>{{ reward.description }}</p>
                                <span v-if="reward.unlocked" class="reward-status unlocked">Unlocked!</span>
                                <span v-else class="reward-status">{{ reward.pointsRequired - userStats.ecoPoints }}
                                    points needed</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stats-actions">
                    <button @click="shareStats" class="share-btn">
                        <i class="fas fa-share-alt"></i> Share Your Impact
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Vue App -->
    <script type="text/javascript">
        let webstore = new Vue({
            el: "#app",
            data: {
                sitename: "EcoShopper",
                products: [],
                showProducts: false,
                checkoutPage: false,
                showReceipt: false,
                isDarkMode: false,
                isAuthenticated: false,
                currentUser: null,
                isLoginPage: false,
                showMap: false,
                orderDetails: {
                    name: '',
                    phone: '',
                    products: [],
                    total: 0,
                    date: ''
                },
                cart: {},
                originalInventory: {}, // Track original inventory levels
                searchQuery: "",
                sortOption: "name", // Default sorting option
                sortOrder: "asc", // Default sort order
                alerts: [],
                order: {
                    name: "",
                    phone: "",
                },
                slideIndex: 0,
                searchResults: [],// Array to store search results
                formErrors: {
                    name: false,
                    phone: false
                },
                debouncedSearch: null,
                isLoading: false,
                stores: [], // Array to store fetched stores
                map: null, // Will hold the Leaflet map instance
                userLocation: null, // Will store user's coordinates
                userMarker: null, // Marker for user's location
                storeMarkers: [], // Array to store map markers
                selectedStore: null, // Currently selected store
                storeProducts: [], // Products at selected store
                activeStoreFilter: null, // For filtering products by store
                showStatsModal: false,
                userStats: {
                    paperSaved: 0,
                    paperSavedTarget: 10, // kg
                    ecoPurchases: 0,
                    purchaseTarget: 50,
                    ecoPoints: 0,
                    nextRewardThreshold: 100,
                    rewards: [
                        {
                            name: "Green Shopper",
                            description: "Complete 5 eco-friendly purchases",
                            pointsRequired: 50,
                            unlocked: false,
                            icon: "fas fa-seedling"
                        },
                        {
                            name: "Paper Saver",
                            description: "Save 5kg of paper",
                            pointsRequired: 100,
                            unlocked: false,
                            icon: "fas fa-file-alt"
                        },
                        {
                            name: "Eco Warrior",
                            description: "Save 10kg of paper",
                            pointsRequired: 200,
                            unlocked: false,
                            icon: "fas fa-award"
                        },
                        {
                            name: "Planet Protector",
                            description: "Complete 25 eco-friendly purchases",
                            pointsRequired: 300,
                            unlocked: false,
                            icon: "fas fa-globe-americas"
                        },
                        {
                            name: "Forest Guardian",
                            description: "Save your first tree (17kg of paper)",
                            pointsRequired: 400,
                            unlocked: false,
                            icon: "fas fa-tree"
                        }
                    ]
                }
            },
            mounted() {
                this.Products = [],
                    this.searchResults = [],
                    this.fetchAllProducts();
                this.checkUserAuth();
                this.$nextTick(() => {
                    this.searchResults = this.products; // Populate searchResults with all products initially
                });

                this.debouncedSearch = this.debounce(this.searchProducts, 300);

                // Fetch stores when app is mounted
                this.fetchStores();
            },
            computed: {
                isLoggedIn() {
                    return localStorage.getItem('user') !== null;
                },
                cartItemCount: function () {
                    return Object.values(this.cart).reduce((total, quantity) => total + quantity, 0);
                },
                cartDetails: function () {
                    const details = [];
                    for (const [productId, quantity] of Object.entries(this.cart)) {
                        const product = this.products.find((c) => c._id === productId || c.id === productId);
                        if (product) {
                            details.push({
                                ...product,
                                quantity: quantity,
                                subtotal: product.price * quantity,
                                maxAvailable: this.originalInventory[productId] || product.availableInventory // Use original inventory for max
                            });
                        }
                    }
                    return details;
                },
                cartTotal() {
                    return this.cartDetails.reduce(
                        (total, item) => total + (item.price * item.quantity),
                        0
                    );
                },
                isOrderValid: function () {
                    return this.isValidName(this.order.name) && this.isValidPhone(this.order.phone);
                },
                getPaperSavedPercentage() {
                    return Math.min(100, (this.userStats.paperSaved / this.userStats.paperSavedTarget) * 100);
                },
                getEcoPurchasesPercentage() {
                    return Math.min(100, (this.userStats.ecoPurchases / this.userStats.purchaseTarget) * 100);
                },
                getTreesSaved() {
                    // Approximate 1 tree saved per 17kg of paper
                    return (this.userStats.paperSaved / 17).toFixed(2);
                }
            },
            methods: {
                goToLogin() {
                    this.isLoginPage = true;
                    this.showProducts = false;
                    this.checkoutPage = false;
                    this.showReceipt = false;
                    this.LandingPage = false;
                },
                toggleTheme() {
                    this.isDarkMode = !this.isDarkMode;
                    document.body.classList.toggle("dark-mode", this.isDarkMode);
                },
                checkUserAuth: function () {
                    // First check localStorage
                    const storedUser = localStorage.getItem('user');
                    if (storedUser) {
                        try {
                            this.currentUser = JSON.parse(storedUser);
                            this.isAuthenticated = true;
                        } catch (e) {
                            console.error('Error parsing stored user', e);
                            localStorage.removeItem('user');
                        }
                    }

                    // Then verify with server
                    this.checkAuthStatus().then(isAuthenticated => {
                        this.isAuthenticated = isAuthenticated;
                        if (!isAuthenticated) {
                            // Clear any invalid stored data
                            localStorage.removeItem('user');
                            this.currentUser = null;
                        }
                    });
                },
                login: async function () {
                    const name = document.querySelector('.login-form input[type="text"]').value;
                    const password = document.querySelector('.login-form input[type="password"]').value;

                    if (!name || !password) {
                        this.alertUser('Please enter both username and password', 'warning');
                        return;
                    }

                    try {
                        const response = await fetch('http://localhost:5500/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name, password })
                        });

                        const data = await response.json();
                        console.log("Login response:", data);

                        if (!response.ok) {
                            throw new Error(data.message || 'Login failed');
                        }

                        this.alertUser('Login successful!', 'success');

                        // Store user info
                        localStorage.setItem('user', JSON.stringify({
                            name: data.name,
                            role: data.role,
                            token: data.token
                        }));
                        this.checkLoginStatus();
                        console.log("Local storage updated");

                        if (data.role === 'admin') {
                            console.log('Redirecting to admin page...');
                            window.location.href = "/admin";  // Redirect to admin page
                        } else {
                            // Navigate back to main page
                            this.isLoginPage = false;
                            this.showProducts = true;

                            console.log("Navigation done, fetching products...");
                            if (this.showProducts) {
                                this.fetchAllProducts();
                            }
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        this.alertUser(error.message || 'Login failed. Please check your credentials.', 'error');
                    }
                },

                signup: async function () {
                    const username = document.querySelector('.signup-form input[type="text"]').value;
                    const email = document.querySelector('.signup-form input[type="email"]').value;
                    const password = document.querySelector('.signup-form input[type="password"]').value;
                    const confirmPassword = document.querySelectorAll('.signup-form input[type="password"]')[1].value; // Select confirm password field

                    if (!username || !email || !password || !confirmPassword) {
                        this.alertUser('All fields are required.', 'warning');
                        return;
                    }

                    if (username.length < 3) {
                        this.alertUser('Username must be at least 3 characters long.', 'warning');
                        return;
                    }

                    if (password.length < 6) {
                        this.alertUser('Password must be at least 6 characters long.', 'warning');
                        return;
                    }

                    if (password !== confirmPassword) {
                        this.alertUser('Passwords do not match.', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('http://localhost:5500/signup', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: username,
                                email: email,
                                password: password,
                                role: "customer" // Default role
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Signup failed.');
                        }

                        this.alertUser('Account created successfully! You can now login.', 'success');

                        // Reset form fields
                        document.querySelector('.signup-form input[type="text"]').value = '';
                        document.querySelector('.signup-form input[type="email"]').value = '';
                        document.querySelectorAll('.signup-form input[type="password"]').forEach(input => input.value = '');

                        // Flip back to login form
                        document.getElementById('flip').checked = false;

                    } catch (error) {
                        console.error('Signup error:', error);
                        this.alertUser(error.message || 'Signup failed. Please try again.', 'error');
                    }
                },
                checkAuthStatus: async function () {
                    try {
                        // First check if we have stored user info and use that
                        const storedUser = localStorage.getItem('user');
                        if (storedUser) {
                            try {
                                const userData = JSON.parse(storedUser);
                                this.currentUser = userData;
                                return true; // Consider user authenticated based on local storage
                            } catch (e) {
                                console.error('Error parsing stored user', e);
                                localStorage.removeItem('user');
                            }
                        }

                        // Only try server authentication if endpoint is working
                        /* Commenting out for now since endpoint returns 404
                        const response = await fetch('http://localhost:5500/auth-status', {
                            method: 'GET',
                            credentials: 'include'
                        });
                
                        if (response.ok) {
                            const data = await response.json();
                            return data.authenticated;
                        }
                        */

                        return false;
                    } catch (error) {
                        console.error('Auth check error:', error);
                        return false;
                    }
                },
                // Logout method
                logout: async function () {
                    try {
                        const response = await fetch('http://localhost:5500/logout', {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            // Clear local storage
                            localStorage.removeItem('user');

                            // Update UI state (assuming you have a variable tracking login status)
                            this.isLoggedIn = false; // Ensure your template reacts to this change
                            this.checkLoginStatus();
                            this.alertUser('Logged out successfully', 'success');
                            window.location.reload();
                            // Redirect to home
                            this.toLandingPage();
                        } else {
                            throw new Error('Logout failed');
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                        this.alertUser('Logout failed. Please try again.', 'error');
                    }
                },

                getAddressFromCoordinates: async function (lat, lng) {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        const data = await response.json();

                        if (data && data.display_name) {
                            // Store the address in state
                            this.userAddress = data.display_name;
                            return data.display_name;
                        } else {
                            throw new Error('Unable to get address');
                        }
                    } catch (error) {
                        console.error('Error getting address:', error);
                        return 'Address not available';
                    }
                },

                //Fetch all products
                fetchAllProducts: async function () {
                    console.log('FETCHING PRODUCTS');
                    try {
                        const response = await fetch('http://localhost:5500/products');
                        if (!response.ok) {
                            throw new Error('Failed to fetch products');
                        }
                        const data = await response.json();
                        // Ensure data is an array before assigning
                        if (Array.isArray(data)) {
                            this.products = data;
                            this.searchResults = data;

                            // Store original inventory levels
                            data.forEach(product => {
                                const productId = product._id || product.id;
                                this.originalInventory[productId] = product.availableInventory;
                            });
                        } else {
                            throw new Error('Products data is not in expected format');
                        }
                    } catch (error) {
                        console.error(error);
                        this.alertUser('Error fetching products. Please try again later.', 'error');
                        // Initialize with empty arrays to prevent rendering errors
                        this.products = [];
                        this.searchResults = [];
                    }
                },

                // Gets current date and time
                getCurrentDate: function () {
                    const date = new Date();
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                // Show home page
                goToHome: function () {
                    this.showReceipt = false;
                    this.showProducts = false;
                    this.checkoutPage = false;
                },

                // Update product availability in backend
                updateAvailability: async function (productId, quantity) {
                    try {
                        console.log('Updating availability:', {
                            productId,
                            quantity
                        });

                        const response = await fetch(`http://localhost:5500/orders/${productId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ quantity }),
                        });

                        console.log('Update response:', {
                            status: response.status,
                            ok: response.ok
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('Update error:', errorData);

                            // Handle specific error cases
                            if (response.status === 400) {
                                this.alertUser(`Not enough stock available. Only ${errorData.availableInventory} more left.`, 'error');
                            } else if (response.status === 404) {
                                this.alertUser('product not found.', 'error');
                            } else {
                                throw new Error('Failed to update availability');
                            }
                            return false;
                        }

                        const responseData = await response.json();
                        console.log('Update response data:', responseData);
                        return true;

                    } catch (error) {
                        console.error('Complete update error:', error);
                        this.alertUser('Error updating product availability. Please try again later.', 'error');
                        return false;
                    }
                },

                addToCart: function (product) {
                    if (this.isLoggedIn) {
                        console.log('Adding to cart:', product._id || product.id, product.name);

                        const productId = product._id || product.id;
                        const originalInventory = this.originalInventory[productId];

                        // Check against original inventory
                        if (this.cart[productId] && this.cart[productId] >= originalInventory) {
                            this.alertUser(`Maximum available stock (${originalInventory}) reached for ${product.name}!`, 'warning');
                            return;
                        }

                        // Initialize or increment quantity
                        if (this.cart[productId]) {
                            this.cart[productId]++;
                        } else {
                            this.$set(this.cart, productId, 1);
                        }

                        // Update displayed inventory
                        const productIndex = this.products.findIndex(c => (c._id || c.id) === productId);
                        if (productIndex !== -1) {
                            this.products[productIndex].availableInventory = originalInventory - this.cart[productId];
                        }

                        this.alertUser(`${product.name} has been added to the cart!`, 'success');
                    }
                    else {
                        this.goToLogin();
                        this.showMap = false;
                    }

                },

                viewStoreProducts: function (store) {
                    if (this.isLoggedIn) {
                        // Set filter and go to products page
                        this.activeStoreFilter = store._id || store.id;
                        this.showMap = false;
                        this.showProducts = true;

                        // Fetch products specific to this store
                        this.fetchProductsByStore(this.activeStoreFilter).then(products => {
                            this.searchResults = products; // Update the displayed products
                            this.alertUser(`Showing products from ${store.name}`, 'success');
                        });
                    } else {
                        this.goToLogin();
                        this.showMap = false;
                    }
                },
                // Alerts for various purposes
                alertUser: function (message, type = 'success') {
                    const alert = {
                        message,
                        type,
                        id: Date.now(),
                        icon: type === 'success' ? 'fas fa-check-circle' :
                            type === 'warning' ? 'fas fa-exclamation-triangle' :
                                'fas fa-times-circle'
                    };

                    this.alerts.push(alert);

                    setTimeout(() => {
                        const index = this.alerts.findIndex(a => a.id === alert.id);
                        if (index !== -1) {
                            this.alerts.splice(index, 1);
                        }
                    }, 3000);
                },

                // Remove cart items
                removeFromCart: function (product) {
                    const productId = product._id || product.id;
                    if (this.cart[productId]) {
                        this.$delete(this.cart, productId);
                        // Decrease quantity or remove if last item
                        // if (this.cart[productId] > 1) {
                        //     this.cart[productId]--;
                        // } else {
                        //     this.$delete(this.cart, productId);
                        // }

                        // Restore displayed inventory based on original inventory
                        const productIndex = this.products.findIndex(c => (c._id || c.id) === productId);
                        if (productIndex !== -1) {
                            const remainingInCart = this.cart[productId] || 0;
                            this.products[productIndex].availableInventory =
                                this.originalInventory[productId] - remainingInCart;
                        }
                    }
                },

                // Shows cart and checkout
                showCheckout() {
                    if (Object.keys(this.cart).length === 0) {
                        alert("Cart is empty! Please select a product to proceed.");
                        return;
                    }

                    if (this.checkoutPage) {
                        this.showProducts = true;
                        this.checkoutPage = false;
                    } else {
                        this.showProducts = false;
                        this.checkoutPage = true;
                        this.showMap = false;
                    }
                },

                viewProducts: function () {

                    if (this.isLoggedIn) {
                        this.showProducts = true;
                        this.showMap = false;
                        this.checkoutPage = false;

                        // Clear store filter when viewing all products
                        this.activeStoreFilter = null;
                        this.searchQuery = "";
                        this.fetchAllProducts();
                    } else {
                        this.goToLogin();
                        this.showMap = false;
                    }
                },

                checkLoginStatus() {
                    this.$forceUpdate();  // Force Vue to refresh computed properties
                },

                toLandingPage: function () {
                    this.showProducts = false;
                    this.isLoginPage = false;
                    this.checkoutPage = false;
                    this.showMap = false;
                },

                // Sort products based on different parameters
                sortProducts: function () {
                    this.products.sort((a, b) => {
                        let comparison = 0;
                        if (this.sortOption === "name") {
                            comparison = a.name.localeCompare(b.name);
                        }
                        else if (this.sortOption === "price") {
                            comparison = a.price - b.price;
                        } else if (this.sortOption === "spaces") {
                            comparison =
                                a.availableInventory - b.availableInventory;
                        } else if (this.sortOption === "category") {
                            comparison = a.category.localeCompare(b.category);
                        }
                        return this.sortOrder === "asc"
                            ? comparison
                            : -comparison;
                    });
                },
                isValidName: function (name) {
                    // Checks if name contains only letters and spaces
                    // Also ensures minimum 2 characters and allows for multiple names
                    const nameRegex = /^[A-Za-z\s]{2,}$/;
                    return nameRegex.test(name.trim());
                },
                isValidPhone: function (phone) {
                    // Checks if phone contains only numbers
                    // Allows for 7-15 digits to accommodate different phone number formats
                    const phoneRegex = /^[0-9]{7,15}$/;
                    return phoneRegex.test(phone.trim());
                },

                // Validate name for checkout
                validateName: function () {
                    this.formErrors.name = !this.isValidName(this.order.name) && this.order.name.length > 0;
                },

                // Validate phone for checkout
                validatePhone: function () {
                    this.formErrors.phone = !this.isValidPhone(this.order.phone) && this.order.phone.length > 0;
                },

                // Time set to prevent multiple searches
                debounce: function (func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },

                // Add this method to reset store filters
                clearStoreFilter: function () {
                    this.activeStoreFilter = null;
                    this.fetchAllProducts().then(() => {
                        this.searchResults = this.products;
                        this.alertUser('Showing all products', 'success');
                    });
                },
                // // Search products request sent from frontend
                searchProducts: async function () {
                    const query = this.searchQuery.trim();

                    try {
                        // If we have an active store filter, use that regardless of search query
                        if (this.activeStoreFilter) {
                            if (query === "") {
                                // Just fetch all products for this store
                                const storeProducts = await this.fetchProductsByStore(this.activeStoreFilter);
                                this.searchResults = storeProducts;
                                return;
                            }

                            // If there's a search query, filter the store products
                            const response = await fetch(`http://localhost:5500/products/store/${this.activeStoreFilter}/search?query=${encodeURIComponent(query)}`);
                            const data = await response.json();
                            this.searchResults = Array.isArray(data) ? data : [];
                            return;
                        }

                        // Normal search functionality (unchanged)
                        if (query === "") {
                            await this.fetchAllProducts();
                            return;
                        }

                        const response = await fetch(`http://localhost:5500/products/search?query=${encodeURIComponent(query)}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        const data = await response.json();

                        if (!Array.isArray(data)) {
                            console.error('Expected search results array but got:', data);
                            this.searchResults = [];
                            return;
                        }

                        if (!response.ok) {
                            if (response.status === 404) {
                                this.searchResults = [];
                                this.alertUser('No products found matching your search', 'warning');
                            } else {
                                throw new Error(data.message || 'Error performing search');
                            }
                            return;
                        }

                        this.searchResults = data;

                        if (data.length > 0) {
                            this.alertUser(`Found ${data.length} product${data.length === 1 ? '' : 's'} matching your search`, 'success');
                        }

                    } catch (error) {
                        console.error('Search error:', error);
                        this.alertUser('Error performing search. Please try again.', 'error');
                        this.searchResults = [];
                    }
                },

                // Used for search functionality
                isSubstring: function (query, name) {
                    for (
                        let i = 0;
                        i <= name.length - query.length;
                        i++
                    ) {
                        let found = true;
                        for (let j = 0; j < query.length; j++) {
                            if (name[i + j] !== query[j]) {
                                found = false;
                                break;
                            }
                        }
                        if (found) {
                            return true;
                        }
                    }
                    return false;
                },
                showNearbyStores: function () {
                    this.showMap = true;
                    this.showProducts = false;
                    this.checkoutPage = false;
                    this.showReceipt = false;
                    this.isLoginPage = false;

                    // Initialize map after the element is rendered
                    this.$nextTick(() => {
                        this.initMap();
                    });
                },

                fetchStores: async function () {
                    try {
                        const response = await fetch('http://localhost:5500/stores');
                        if (!response.ok) {
                            throw new Error('Failed to fetch stores');
                        }

                        const data = await response.json();
                        if (Array.isArray(data)) {
                            this.stores = data;
                        } else {
                            throw new Error('Stores data is not in expected format');
                        }
                    } catch (error) {
                        console.error('Error fetching stores:', error);
                        this.alertUser('Error fetching nearby stores. Please try again later.', 'error');
                        this.stores = [];
                    }
                },

                initMap: function () {
                    // Create map if map container exists
                    const mapContainer = document.getElementById('storeMap');
                    if (!mapContainer) return;

                    // Initialize map
                    this.map = L.map('storeMap').setView([25.276987, 55.296249], 13); // Default to Dubai

                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);

                    // Get user location
                    this.getUserLocation();

                    // Add store markers
                    this.addStoreMarkers();
                },

                getUserLocation: function () {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                // Store user location
                                this.userLocation = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };

                                // Center map on user location
                                this.map.setView([this.userLocation.lat, this.userLocation.lng], 13);

                                // Add user marker
                                if (this.userMarker) {
                                    this.userMarker.setLatLng([this.userLocation.lat, this.userLocation.lng]);
                                } else {
                                    // Create user location marker with custom icon
                                    const userIcon = L.divIcon({
                                        html: '<i class="fas fa-user-circle" style="font-size: 24px; color: #3388ff;"></i>',
                                        className: 'user-marker',
                                        iconSize: [24, 24],
                                        iconAnchor: [12, 12]
                                    });

                                    this.userMarker = L.marker([this.userLocation.lat, this.userLocation.lng], {
                                        icon: userIcon
                                    }).addTo(this.map);

                                    this.userMarker.bindPopup('You are here').openPopup();
                                }

                                // Calculate distances from user to stores
                                this.calculateStoreDistances();
                            },
                            (error) => {
                                console.error('Error getting location:', error);
                                this.alertUser('Could not access your location. Using default map view.', 'warning');
                            }
                        );
                    } else {
                        this.alertUser('Geolocation is not supported by your browser.', 'warning');
                    }
                },

                calculateStoreDistances: function () {
                    if (!this.userLocation) return;

                    // Calculate distance from user to each store
                    this.stores.forEach(store => {
                        if (store.location && store.location.latitude && store.location.longitude) {
                            // Calculate distance using Haversine formula
                            store.distance = this.getDistance(
                                this.userLocation.lat,
                                this.userLocation.lng,
                                store.location.latitude,
                                store.location.longitude
                            );
                        }
                    });

                    // Sort stores by distance
                    this.stores.sort((a, b) => (a.distance || Infinity) - (b.distance || Infinity));

                    // Refresh markers to update popups with distance info
                    this.refreshStoreMarkers();
                },

                getDistance: function (lat1, lon1, lat2, lon2) {
                    // Haversine formula to calculate distance between two points
                    const R = 6371e3; // Earth radius in meters
                    const φ1 = lat1 * Math.PI / 180;
                    const φ2 = lat2 * Math.PI / 180;
                    const Δφ = (lat2 - lat1) * Math.PI / 180;
                    const Δλ = (lon2 - lon1) * Math.PI / 180;

                    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                    return R * c; // Distance in meters
                },

                addStoreMarkers: function () {
                    if (!this.map) return;

                    // Clear existing markers
                    this.clearStoreMarkers();

                    // Add markers for each store
                    this.stores.forEach(store => {
                        if (store.location && store.location.latitude && store.location.longitude) {
                            const marker = L.marker([store.location.latitude, store.location.longitude])
                                .addTo(this.map);

                            // Create popup content
                            let popupContent = `
                                <div class="store-popup">
                                    <h3>${store.name}</h3>
                                    <p>${store.address || ''}</p>
                            `;

                            if (store.distance) {
                                popupContent += `<p>${(store.distance / 1000).toFixed(2)} km away</p>`;
                            }

                            const popup = L.popup().setContent(popupContent);
                            marker.bindPopup(popup);

                            // Add click event to marker
                            marker.on('click', () => {
                                this.selectStore(store);
                            });

                            // Also add click event to the View Store button in popup
                            marker.on('popupopen', () => {
                                const viewStoreBtn = document.querySelector('.view-store-btn');
                                if (viewStoreBtn) {
                                    viewStoreBtn.addEventListener('click', () => {
                                        this.selectStore(store);
                                    });
                                }
                            });

                            // Store the marker reference
                            this.storeMarkers.push({
                                storeId: store._id || store.id,
                                marker: marker
                            });
                        }
                    });
                },

                clearStoreMarkers: function () {
                    // Remove all existing markers from map
                    this.storeMarkers.forEach(markerData => {
                        this.map.removeLayer(markerData.marker);
                    });
                    this.storeMarkers = [];
                },

                refreshStoreMarkers: function () {
                    // Refresh all markers to update popups
                    this.clearStoreMarkers();
                    this.addStoreMarkers();
                },

                centerUserLocation: function () {
                    if (this.userLocation && this.map) {
                        this.map.setView([this.userLocation.lat, this.userLocation.lng], 13);
                    } else {
                        this.getUserLocation();
                    }
                },

                selectStore: function (store) {
                    this.selectedStore = store;

                    // Fetch products for this store
                    this.fetchProductsByStore(store._id || store.id);

                    // Highlight the selected store marker
                    this.highlightStoreMarker(store._id || store.id);
                },

                highlightStoreMarker: function (storeId) {
                    // Reset all markers to default style
                    this.storeMarkers.forEach(markerData => {
                        markerData.marker.setIcon(L.icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/images/marker-icon.png',
                            iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/images/marker-icon-2x.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        }));
                    });

                    // Set selected marker to highlighted style
                    const selectedMarker = this.storeMarkers.find(m => m.storeId === storeId);
                    if (selectedMarker) {
                        // You could use a custom icon for the selected store if needed
                        // For now, just open its popup
                        selectedMarker.marker.openPopup();
                    }
                },

                closeStoreSidebar: function () {
                    this.selectedStore = null;
                    this.storeProducts = [];
                },

                fetchProductsByStore: async function (storeId) {
                    try {
                        const response = await fetch(`http://localhost:5500/products/store/${storeId}`);
                        if (!response.ok) {
                            throw new Error('Failed to fetch store products');
                        }

                        const data = await response.json();
                        if (Array.isArray(data)) {
                            this.storeProducts = data; // Still store for sidebar view
                            return data; // Return the data for use in other methods
                        } else {
                            throw new Error('Products data is not in expected format');
                        }
                    } catch (error) {
                        console.error('Error fetching store products:', error);
                        this.alertUser('Error fetching products for this store.', 'error');
                        this.storeProducts = [];
                        return [];
                    }
                },

                viewStoreProducts: function (store) {
                    if (this.isLoggedIn) {
                        // Set filter and go to products page
                        this.activeStoreFilter = store._id || store.id;
                        this.showMap = false;
                        this.showProducts = true;

                        // Fetch products specific to this store
                        this.fetchProductsByStore(this.activeStoreFilter).then(products => {
                            this.searchResults = products; // Update the displayed products
                            this.alertUser(`Showing products from ${store.name}`, 'success');
                        });
                    } else {
                        this.goToLogin();
                        this.showMap = false;
                    }
                },
                // Show stats modal
                showStats() {
                    // First fetch latest stats
                    this.fetchUserStats();
                    this.showStatsModal = true;
                },

                // Close stats modal
                closeStatsModal() {
                    this.showStatsModal = false;
                },

                // Fetch user stats from backend
                fetchUserStats: async function () {
                    if (!this.isAuthenticated) return;

                    try {
                        const response = await fetch('http://localhost:5500/user/stats/all-stats', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.currentUser?.token || ''}`
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Failed to fetch user stats');
                        }

                        const data = await response.json();
                        this.userStats = data;

                    } catch (error) {
                        console.error('Error fetching user stats:', error);
                        // Use default stats if there's an error
                    }
                },

                // Update user stats after placing an order
                updateUserStats: async function (orderDetails) {
                    if (!this.isAuthenticated) return;

                    // Calculate paper saved based on order
                    // Assumption: Each product in a flyer would use about 5g of paper
                    const paperSaved = orderDetails.products.reduce((total, product) => {
                        return total + (product.quantity * 0.005); // 5g per product
                    }, 0);

                    const statsUpdate = {
                        paperSaved: paperSaved,
                        ecoPurchases: orderDetails.products.length,
                        orderId: orderDetails.id
                    };

                    try {
                        const response = await fetch('http://localhost:5500/user/stats/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.currentUser?.token || ''}`
                            },
                            body: JSON.stringify(statsUpdate)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error('Server error details:', errorData);
                            throw new Error(`Failed to update user stats: ${response.status} ${response.statusText}`);
                        }

                        // Refresh stats
                        this.fetchUserStats();

                    } catch (error) {
                        console.error('Error updating user stats:', error);
                    }
                },

                // Share stats on social media
                shareStats() {
                    // Create share text
                    const shareText = `I've saved ${this.userStats.paperSaved.toFixed(2)}kg of paper and approximately ${this.getTreesSaved} trees by using EcoShopper! Join me in reducing paper waste.`;

                    // Basic implementation - open a share dialog
                    if (navigator.share) {
                        navigator.share({
                            title: 'My EcoShopper Impact',
                            text: shareText,
                            url: window.location.href
                        })
                            .then(() => this.alertUser('Shared successfully!', 'success'))
                            .catch(error => console.error('Error sharing:', error));
                    } else {
                        // Fallback for browsers that don't support Web Share API
                        // Copy to clipboard
                        navigator.clipboard.writeText(shareText)
                            .then(() => this.alertUser('Stats copied to clipboard. Share with your friends!', 'success'))
                            .catch(err => this.alertUser('Could not copy text. Please share manually.', 'warning'));
                    }
                },
                // Add order to database, request sent from frontend
                addOrder: async function () {
                    this.isLoading = true;
                    try {
                        // Get address from coordinates if we have them
                        let addressToUse = 'Address not provided';
                        if (this.userLocation) {
                            addressToUse = await this.getAddressFromCoordinates(
                                this.userLocation.lat,
                                this.userLocation.lng
                            );
                        }

                        const orderData = {
                            name: this.order.name,
                            phone: this.order.phone,
                            address: addressToUse,
                            cart: this.cartDetails.map(product => ({
                                id: product._id || product.id,
                                name: product.name,
                                price: product.price,
                                quantity: product.quantity
                            })),
                            total: this.cartTotal,
                            timestamp: new Date().toISOString()
                        };

                        const response = await fetch('http://localhost:5500/orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(orderData),
                        });

                        if (!response.ok) {
                            throw new Error('Failed to place the order');
                        }

                        const orderResponse = await response.json();

                        // Update backend inventory
                        for (let product of this.cartDetails) {
                            await this.updateAvailability(product._id || product.id, product.quantity);
                        }

                        // Update receipt
                        this.orderDetails = {
                            id: orderResponse.orderId || 'unknown',
                            name: this.order.name,
                            phone: this.order.phone,
                            address: addressToUse,
                            products: this.cartDetails,
                            total: this.cartTotal,
                            date: this.getCurrentDate()
                        };

                        // Update user stats with the order details
                        if (this.isAuthenticated) {
                            await this.updateUserStats(this.orderDetails);
                        }

                        this.alertUser('Order placed successfully!', 'success');

                        // Reset cart and form
                        this.cart = {};
                        this.order.name = '';
                        this.order.phone = '';

                        this.checkoutPage = false;
                        this.showReceipt = true;

                        // Refresh products data
                        await this.fetchAllProducts();

                    } catch (error) {
                        console.error(error);
                        this.alertUser('Error placing the order. Please try again later.', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
            },
            created() {
                this.checkLoginStatus();
                window.addEventListener('storage', this.checkLoginStatus);
            },
        });
    </script>
</body>

</html>