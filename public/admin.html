<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script>document.getElementsByTagName("html")[0].className += " js";</script>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/adminStyles.css">
  <title>Admin - EcoShopper</title>
</head>

<body>
  <header class="cd-main-header js-cd-main-header">
    <div class="cd-logo-wrapper">
      <a href="#0" class="cd-logo"><img src="https://ecoshopper-backend.onrender.com/images/EcoShopperAdminLogo.png" alt="Logo"></a>
    </div>

    <div class="cd-search js-cd-search">
      <form>
        <input class="reset" type="search" placeholder="Search...">
      </form>
    </div>

    <button class="reset cd-nav-trigger js-cd-nav-trigger" aria-label="Toggle menu"><span></span></button>

    <ul class="cd-nav__list js-cd-nav__list">
      <li class="cd-nav__item cd-nav__item--has-children cd-nav__item--account js-cd-item--has-children">
        <a href="#0">
          <img src="https://ecoshopper-backend.onrender.com/images/cd-avatar.svg" alt="avatar">
          <span>Account</span>
        </a>

        <ul class="cd-nav__sub-list">
          <li class="cd-nav__sub-item"><a href="#0">My Account</a></li>
          <li class="cd-nav__sub-item"><a href="#" onclick="logout()">Logout</a></li>
        </ul>
      </li>
    </ul>
  </header> <!-- .cd-main-header -->

  <main class="cd-main-content">
    <nav class="cd-side-nav js-cd-side-nav">
      <ul class="cd-side__list js-cd-side__list">
        <li class="cd-side__label"><span>Main</span></li>
        <li class="cd-side__item cd-side__item--has-children cd-side__item--overview js-cd-item--has-children">
          <a href="#0" onclick="showSection('dashboard-home')">Dashboard</a>
        </li>
        <li class="cd-side__label"><span>Management</span></li>
        <li class="cd-side__item cd-side__item--has-children cd-side__item--bookmarks js-cd-item--has-children">
          <a href="#0">Stores</a>

          <ul class="cd-side__sub-list">
            <li class="cd-side__sub-item"><a href="#0" onclick="showSection('add-store'); return false;">Add New
                Store</a></li>
            <li class="cd-side__sub-item"><a href="#0" onclick="showSection('view-stores'); return false;">View/Edit
                Stores</a></li>
          </ul>
        </li>

        <li class="cd-side__item cd-side__item--has-children cd-side__item--products js-cd-item--has-children">
          <a href="#0">Products</a>

          <ul class="cd-side__sub-list">
            <li class="cd-side__sub-item"><a href="#0" onclick="showSection('view-products'); return false;">View
                Products by Store</a></li>
            <li class="cd-side__sub-item"><a href="#0" onclick="showSection('add-products'); return false;">Add
                Products</a></li>
          </ul>
        </li>

        <li class="cd-side__item cd-side__item--has-children cd-side__item--users js-cd-item--has-children">
          <a href="#0">Users</a>

          <ul class="cd-side__sub-list">
            <li class="cd-side__sub-item"><a href="#0" onclick="showSection('add-user'); return false;">Add New
                Admin</a>
            </li>
            <li class="cd-side__sub-item"><a href="#0" onclick="showSection('manage-admins'); return false;">Manage
                Admins</a></li>
          </ul>
        </li>
      </ul>
    </nav>

    <div class="cd-content-wrapper">
      <!-- Dashboard Home -->
      <div id="dashboard-home" class="admin-section active section-container">
        <h1 class="section-title">EcoShopper Admin Dashboard</h1>
        <p>Welcome to the EcoShopper admin dashboard. Select an option from the sidebar to manage your application.</p>
        <div class="dashboard-stats">
          <div class="stat-card">
            <h3 id="total-stores">Loading...</h3>
            <h4>Total Stores</h4>
          </div>
          <div class="stat-card">
            <h3 id="total-products">Loading...</h3>
            <h4>Total Products</h4>
          </div>
          <div class="stat-card">
            <h3 id="registered-users">Loading...</h3>
            <h4>Registered Users</h4>
          </div>
        </div>
      </div>

      <!-- Stores Sections -->
      <div id="add-store" class="admin-section section-container">
        <h2 class="section-title">Add New Store</h2>
        <form id="store-form">
          <div class="form-group">
            <label for="store-name">Store Name</label>
            <input type="text" id="store-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="store-address">Address</label>
            <input type="text" id="store-address" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="store-city">City</label>
            <input type="text" id="store-city" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="store-country">Country</label>
            <input type="text" id="store-country" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="store-phone">Phone</label>
            <input type="tel" id="store-phone" class="form-control">
          </div>
          <button type="submit" class="btn">Add Store</button>
        </form>
      </div>

      <div id="view-stores" class="admin-section section-container">
        <h2 class="section-title">View/Edit Stores</h2>
        <table id="stores-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>City</th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stores-list">

          </tbody>
        </table>
      </div>

      <!-- Products Section -->
      <div id="view-products" class="admin-section section-container">
        <h2 class="section-title">View Products by Store</h2>

        <div class="form-group">
          <label for="store-select">Select Store</label>
          <select id="store-select" class="form-control" onchange="loadProductsByStore(this.value)">
            <option value="">-- Select a Store --</option>
            <!-- Store options will be loaded dynamically -->
          </select>
        </div>

        <div id="products-container" style="margin-top: 20px;">
          <table id="products-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Price</th>
                <th>Category</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="products-list">
              <!-- Product data will be loaded here dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Products Section with Tabs -->
      <div id="add-products" class="admin-section section-container">
        <h2 class="section-title">Add Products</h2>

        <!-- Tab navigation -->
        <div class="tab">
          <button class="tablinks active" onclick="openProductTab(event, 'single-product')">Add Single Product</button>
          <button class="tablinks" onclick="openProductTab(event, 'bulk-upload')">Bulk Import</button>
        </div>

        <!-- Single Product Tab -->
        <div id="single-product" class="tabcontent active">
          <div class="card">
            <div class="card-header">
              <h3>Add Single Product</h3>
            </div>
            <div class="card-body">
              <form id="product-form">
                <div class="form-group">
                  <label for="product-store">Store</label>
                  <select id="product-store" class="form-control" required>
                    <option value="">-- Select a Store --</option>
                    <!-- Store options will be loaded dynamically -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="product-name">Product Name</label>
                  <input type="text" id="product-name" class="form-control" required>
                </div>
                <div class="form-group">
                  <label for="product-price">Price ($)</label>
                  <input type="number" id="product-price" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                  <label for="product-category">Category</label>
                  <input type="text" id="product-category" class="form-control" required>
                </div>
                <div class="form-group">
                  <label for="product-stock">Stock</label>
                  <input type="number" id="product-stock" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                  <label for="product-imageurl">Image link</label>
                  <textarea id="product-imageurl" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Add Product</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Bulk Upload Tab -->
        <div id="bulk-upload" class="tabcontent">
          <div class="card">
            <div class="card-header">
              <h3>Bulk Import Products</h3>
            </div>
            <div class="card-body">
              <p>Upload an Excel file (.xlsx) with product information. The Excel file should have the following
                columns:</p>
              <ul style="margin-bottom: 15px;">
                <li>store_id (required)</li>
                <li>name (required)</li>
                <li>description</li>
                <li>price (required)</li>
                <li>category (required)</li>
                <li>availableInventory</li>
                <li>image</li>
              </ul>

              <a href="#" id="download-template" class="btn" style="margin-bottom: 15px;">Download Template</a>

              <form id="excel-upload-form">
                <div class="form-group">
                  <label for="store-for-excel">Store (if not specified in Excel)</label>
                  <select id="store-for-excel" class="form-control">
                    <option value="">-- Select a Store --</option>
                    <!-- Store options will be loaded dynamically -->
                  </select>
                  <small class="form-text text-muted">If store_id column is not provided in Excel, all products will be
                    assigned to this store.</small>
                </div>
                <div class="form-group">
                  <label for="excel-file">Excel File</label>
                  <input type="file" id="excel-file" class="form-control" accept=".xlsx, .xls" required>
                </div>
                <button type="submit" class="btn">Upload Products</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Sections -->
      <div id="add-user" class="admin-section section-container">
        <h2 class="section-title">Add New Admin</h2>
        <form id="user-form">
          <div class="form-group">
            <label for="user-name">Full Name</label>
            <input type="text" id="user-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="user-email">Email</label>
            <input type="email" id="user-email" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="user-password">Password</label>
            <input type="password" id="user-password" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="user-role">Role</label>
            <select id="user-role" class="form-control" required>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="btn">Add User</button>
        </form>
      </div>

      <div id="manage-admins" class="admin-section section-container">
        <h2 class="section-title">Manage Admin Users</h2>
        <table id="admins-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Created On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="admins-list">
            <!-- Admin user data will be loaded here dynamically -->
          </tbody>
        </table>
      </div>
    </div> <!-- .content-wrapper -->
  </main> <!-- .cd-main-content -->

  <script src="./js/util.js"></script> <!-- util functions included in the CodyHouse framework -->
  <script src="./js/menu-aim.js"></script>
  <script src="./js/main.js"></script>
  <script>
    // Logout method
    async function logout() {
      try {
        const response = await fetch('https://ecoshopper-backend.onrender.com/logout', {
          method: 'POST',
          credentials: 'include'
        });

        if (response.ok) {
          // Clear local storage
          localStorage.removeItem('user');

          // Show logout alert
          alert('Logged out successfully'); // Simple alternative

          // Reload the page
          window.location.reload();
          window.location.href = "/";
        } else {
          throw new Error('Logout failed');
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('Logout failed. Please try again.'); // Handle errors properly
      }
    }
    // Show section function
    function showSection(sectionId) {
      // Hide all sections
      const sections = document.querySelectorAll('.admin-section');
      sections.forEach(section => {
        section.classList.remove('active');
      });

      // Show the selected section
      const selectedSection = document.getElementById(sectionId);
      if (selectedSection) {
        selectedSection.classList.add('active');
      }

      // Load section data if needed
      loadSectionData(sectionId);
    }

    // Load section data based on section ID
    function loadSectionData(sectionId) {
      switch (sectionId) {
        case 'dashboard-home':
          loadDashboardStats();
          break;
        case 'view-stores':
          loadStores();
          break;
        case 'manage-admins':
          loadAdmins();
          break;
        case 'view-products':
          loadStoresForProductView();
          break;
        case 'add-products':
          loadStoresForProductForms();
          break;
      }
    }
    // Function to open product tabs
    function openProductTab(evt, tabName) {
      // Declare all variables
      var i, tabcontent, tablinks;

      // Get all elements with class="tabcontent" and hide them
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
      }

      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
      }

      // Show the current tab, and add an "active" class to the button that opened the tab
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    async function loadDashboardStats() {
      try {
        // Set loading indicators
        document.getElementById('total-stores').textContent = 'Loading...';
        document.getElementById('total-products').textContent = 'Loading...';
        document.getElementById('registered-users').textContent = 'Loading...';

        // Get user role information
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const role = user.role || '';

        // Add role to headers for all requests
        const headers = {
          'X-User-Role': role,
          'Content-Type': 'application/json'
        };

        // Stores count
        try {
          const storesResponse = await fetch('https://ecoshopper-backend.onrender.com/stores/total/count', {
            headers
          });
          if (storesResponse.ok) {
            const storesData = await storesResponse.json();
            document.getElementById('total-stores').textContent = storesData.count;
          } else {
            document.getElementById('total-stores').textContent = 'Error';
            console.error('Failed to fetch stores count:', await storesResponse.text());
          }
        } catch (error) {
          document.getElementById('total-stores').textContent = 'Error';
          console.error('Error loading stores count:', error);
        }

        // Products count
        try {
          const productsResponse = await fetch('https://ecoshopper-backend.onrender.com/products/count', {
            headers
          });
          if (productsResponse.ok) {
            const productsData = await productsResponse.json();
            document.getElementById('total-products').textContent = productsData.count;
          } else {
            document.getElementById('total-products').textContent = 'Error';
            console.error('Failed to fetch products count:', await productsResponse.text());
          }
        } catch (error) {
          document.getElementById('total-products').textContent = 'Error';
          console.error('Error loading products count:', error);
        }

        // Users count
        try {
          const usersResponse = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/user/count', {
            headers
          });
          if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            document.getElementById('registered-users').textContent = usersData.count;
          } else {
            document.getElementById('registered-users').textContent = 'Error';
            console.error('Failed to fetch users count:', await usersResponse.text());
          }
        } catch (error) {
          document.getElementById('registered-users').textContent = 'Error';
          console.error('Error loading users count:', error);
        }
      } catch (error) {
        console.error('Error in loadDashboardStats function:', error);
      }
    }
    // Make sure to call loadDashboardStats when the page loads
    document.addEventListener('DOMContentLoaded', function () {
      // Show dashboard by default
      showSection('dashboard-home');

      // Initialize tab view - select the first tab by default
      const firstTab = document.querySelector('.tablinks');
      if (firstTab) {
        firstTab.classList.add('active');
        const firstTabContent = document.querySelector('.tabcontent');
        if (firstTabContent) {
          firstTabContent.classList.add('active');
        }
      }
    });

    async function loadStores() {
      try {
        const user = JSON.parse(localStorage.getItem('user')); // Parse stored user data
        const role = user ? user.role : null; // Extract role

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/all-stores', {
          method: 'GET',
          headers: {
            'X-User-Role': role, // Custom header to send role
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          console.error(`Error ${response.status}:`, await response.text());
          return;
        }

        const stores = await response.json();
        const tableBody = document.getElementById('stores-list');
        tableBody.innerHTML = '';

        stores.forEach(store => {
          const row = document.createElement('tr');
          row.innerHTML = `
        <td>${store.name}</td>
        <td>${store.category}</td>
        <td>${store.city}</td>
        <td>${store.phone || 'N/A'}</td>
        <td>
          <button class="btn btn-sm" onclick="editStore('${store._id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteStore('${store._id}')">Delete</button>
        </td>
      `;
          tableBody.appendChild(row);
        });

      } catch (error) {
        console.error('Error loading stores:', error);
      }
    }


    // Store form submission
    document.getElementById('store-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const form = this;
      const id = form.dataset.id;
      const action = form.dataset.action;

      const storeData = {
        name: document.getElementById('store-name').value,
        address: document.getElementById('store-address').value,
        city: document.getElementById('store-city').value,
        country: document.getElementById('store-country').value,
        phone: document.getElementById('store-phone').value,
      };

      try {
        const user = JSON.parse(localStorage.getItem('user')); // Parse stored user data
        const role = user ? user.role : null; // Extract role
        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        // Check if this is an update or create operation
        if (action === 'update' && id) {
          // Update existing store
          const response = await fetch(`https://ecoshopper-backend.onrender.com/admin/fn/updateStore/${id}`, {
            method: 'PUT',
            headers: {
              'X-User-Role': role,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(storeData)
          });

          if (response.ok) {
            alert('Store updated successfully!');
            // Reset form state
            form.reset();
            form.dataset.action = 'create';
            delete form.dataset.id;
            form.querySelector('button[type="submit"]').textContent = 'Add Store';
            // Refresh the store list
            loadStores(); 
            // Go back to the stores list view
            showSection('view-stores');
          } else {
            throw new Error('Failed to update store');
          }
        } else {
          // Create new store
          const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/add-store', {
            method: 'POST',
            headers: {
              'X-User-Role': role,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(storeData)
          });

          if (response.ok) {
            alert('Store added successfully!');
            showSection('view-stores');
            // form.reset();
            // // Refresh the store list if needed
            // if (typeof loadStores === 'function') loadStores();
          } else {
            throw new Error('Failed to add store');
          }
        }
      } catch (error) {
        console.error('Error processing store:', error);
        alert(`Error: ${error.message}. Please try again.`);
      }
    });

    // Admin users functions
    async function loadAdmins() {
      try {
        const user = JSON.parse(localStorage.getItem('user')); // Get logged-in user
        const role = user ? user.role : null;
        const currentUserName = user ? user.name : null; // Logged-in user's name

        if (!role || !currentUserName) {
          console.error("Missing role or name. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/get-admins', {
          method: 'GET',
          headers: {
            'X-User-Role': role
          }
        });

        if (response.ok) {
          const admins = await response.json();
          const tableBody = document.getElementById('admins-list');
          tableBody.innerHTML = '';

          admins.forEach(admin => {
            const createdDate = new Date(admin.createdAt).toLocaleDateString();
            const isCurrentUser = admin.name === currentUserName;

            const row = document.createElement('tr');
            row.innerHTML = `
          <td>${admin.name}</td>
          <td>${admin.email}</td>
          <td>${admin.role}</td>
          <td>${createdDate}</td>
          <td>
            ${isCurrentUser ? '<em>You</em>' : `<button class="btn btn-sm btn-danger" onclick="deleteUser('${admin._id}')">Delete</button>`}
          </td>
        `;
            tableBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading admin users:', error);
      }
    }


    // User form submission
    document.getElementById('user-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const userData = {
        name: document.getElementById('user-name').value,
        email: document.getElementById('user-email').value,
        password: document.getElementById('user-password').value,
        role: document.getElementById('user-role').value
      };

      try {
        const user = JSON.parse(localStorage.getItem('user')); // Parse stored user data
        const role = user ? user.role : null; // Extract role

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/addUser', {
          method: 'POST',
          headers: {
            'X-User-Role': role,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          alert('User added successfully!');
          document.getElementById('user-form').reset();
        } else {
          throw new Error('Failed to add user');
        }
      } catch (error) {
        console.error('Error adding user:', error);
        alert('Error adding user. Please try again.');
      }
    });

    // CRUD operations for all entities
    async function editStore(id) {
      // Validate ID before making request
      if (!id) {
        console.error("Missing store ID");
        alert("Error: Cannot edit store with invalid ID");
        return;
      }

      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const role = user ? user.role : null;

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch(`https://ecoshopper-backend.onrender.com/admin/fn/updateStore/${id}`, {
          method: 'PUT',
          headers: {
            'X-User-Role': role,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const store = await response.json();
          // Populate form and show edit view
          showSection('add-store');
          document.getElementById('store-name').value = store.name;
          document.getElementById('store-address').value = store.address;
          document.getElementById('store-city').value = store.city;
          document.getElementById('store-country').value = store.country;
          document.getElementById('store-phone').value = store.phone || '';

          // Change form action to update
          const form = document.getElementById('store-form');
          form.dataset.id = id;
          form.dataset.action = 'update';

          // Change button text
          form.querySelector('button[type="submit"]').textContent = 'Update Store';
        }
      } catch (error) {
        console.error('Error loading store for edit:', error);
      }
    }

    async function deleteStore(id) {
      if (confirm('Are you sure you want to delete this store?')) {
        try {
          const user = JSON.parse(localStorage.getItem('user')); // Parse stored user data
          const role = user ? user.role : null; // Extract role

          if (!role) {
            console.error("No role found. User might not be logged in.");
            return;
          }

          const response = await fetch(`https://ecoshopper-backend.onrender.com/admin/fn/delete/${id}`, {
            method: 'DELETE',
            headers: {
              'X-User-Role': role,
              'Content-Type': 'application/json'
            },
          });

          if (response.ok) {
            alert('Store deleted successfully!');
            loadStores();
          } else {
            throw new Error('Failed to delete store');
          }
        } catch (error) {
          console.error('Error deleting store:', error);
          alert('Error deleting store. Please try again.');
        }
      }
    }

    // Load stores for the dropdown
    async function loadStoresForProductView() {
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const role = user ? user.role : null;

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/all-stores', {
          method: 'GET',
          headers: {
            'X-User-Role': role,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const stores = await response.json();
        const storeSelect = document.getElementById('store-select');

        // Clear existing options except the first one
        while (storeSelect.options.length > 1) {
          storeSelect.remove(1);
        }

        // Add store options
        stores.forEach(store => {
          const option = document.createElement('option');
          option.value = store._id;
          option.textContent = store.name;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading stores for dropdown:', error);
      }
    }

    // Load products for a specific store
    async function loadProductsByStore(storeId) {
      if (!storeId) {
        document.getElementById('products-list').innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`https://ecoshopper-backend.onrender.com/products/store/${storeId}`);

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const products = await response.json();
        const tableBody = document.getElementById('products-list');
        tableBody.innerHTML = '';

        if (products.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No products found for this store</td></tr>';
          return;
        }

        products.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
          <td>${product.name || 'N/A'}</td>
          <td>${product.price ? 'AED' + product.price.toFixed(2) : 'N/A'}</td>
          <td>${product.category || 'N/A'}</td>
          <td>${product.availableInventory || '0'}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product._id}')">Delete</button>
          </td>
        `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('products-list').innerHTML =
          '<tr><td colspan="5" style="text-align: center;">Error loading products. Please try again.</td></tr>';
      }
    }

    // Delete product function
    async function deleteProduct(id) {
      if (confirm('Are you sure you want to delete this product?')) {
        try {
          const user = JSON.parse(localStorage.getItem('user'));
          const role = user ? user.role : null;

          if (!role) {
            console.error("No role found. User might not be logged in.");
            return;
          }
          const response = await fetch(`https://ecoshopper-backend.onrender.com/admin/fn/products/delete/${id}`, {
            method: 'DELETE',
            headers: {
              'X-User-Role': role
            }
          });

          if (response.ok) {
            alert('Product deleted successfully!');
            // Reload products for the current store
            loadProductsByStore(document.getElementById('store-select').value);
          } else {
            throw new Error('Failed to delete product');
          }
        } catch (error) {
          console.error('Error deleting product:', error);
          alert('Error deleting product. Please try again.');
        }
      }
    }

    // Load stores for product form dropdowns
    async function loadStoresForProductForms() {
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const role = user ? user.role : null;

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/all-stores', {
          method: 'GET',
          headers: {
            'X-User-Role': role,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const stores = await response.json();

        // Populate single product form dropdown
        const singleProductStoreSelect = document.getElementById('product-store');
        while (singleProductStoreSelect.options.length > 1) {
          singleProductStoreSelect.remove(1);
        }

        // Populate bulk upload form dropdown
        const bulkUploadStoreSelect = document.getElementById('store-for-excel');
        while (bulkUploadStoreSelect.options.length > 1) {
          bulkUploadStoreSelect.remove(1);
        }

        // Add store options to both dropdowns
        stores.forEach(store => {
          // For single product form
          const singleOption = document.createElement('option');
          singleOption.value = store._id;
          singleOption.textContent = store.name;
          singleProductStoreSelect.appendChild(singleOption);

          // For bulk upload form
          const bulkOption = document.createElement('option');
          bulkOption.value = store._id;
          bulkOption.textContent = store.name;
          bulkUploadStoreSelect.appendChild(bulkOption);
        });

        console.log("Store options added to product form dropdowns");
      } catch (error) {
        console.error('Error loading stores for product forms:', error);
      }
    }

    // Handle single product form submission
    document.getElementById('product-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const productData = {
        store_id: document.getElementById('product-store').value,
        name: document.getElementById('product-name').value,
        price: parseFloat(document.getElementById('product-price').value),
        category: document.getElementById('product-category').value,
        availableInventory: parseInt(document.getElementById('product-stock').value),
        image: document.getElementById('product-imageurl').value
      };

      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const role = user ? user.role : null;

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/add-product', {
          method: 'POST',
          headers: {
            'X-User-Role': role,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(productData)
        });

        if (response.ok) {
          alert('Product added successfully!');
          document.getElementById('product-form').reset();
        } else {
          throw new Error('Failed to add product');
        }
      } catch (error) {
        console.error('Error adding product:', error);
        alert('Error adding product. Please try again.');
      }
    });

    // Handle Excel file download template
    document.getElementById('download-template').addEventListener('click', function (e) {
      e.preventDefault();

      // Create a template Excel file
      const template = 'store_id,name,price,category,image,availableInventory\n,,,,';

      // Create a blob and download link
      const blob = new Blob([template], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = 'product_template.csv';

      document.body.appendChild(a);
      a.click();

      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    });

    // Handle Excel file upload
    document.getElementById('excel-upload-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById('excel-file');
      const storeId = document.getElementById('store-for-excel').value;

      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select an Excel file');
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      if (storeId) {
        formData.append('store_id', storeId);
      }

      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const role = user ? user.role : null;

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch('https://ecoshopper-backend.onrender.com/admin/fn/products/upload', {
          method: 'POST',
          headers: {
            'X-User-Role': role,
          },
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          alert(`Excel import successful! Added ${result.added} products.`);
          document.getElementById('excel-upload-form').reset();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to upload products');
        }
      } catch (error) {
        console.error('Error uploading products:', error);
        alert(`Error uploading products: ${error.message}`);
      }
    });

    async function editUser(id) {
      // Validate ID before making request
      if (!id) {
        console.error("Missing user ID");
        alert("Error: Cannot edit user with invalid ID");
        return;
      }
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const role = user ? user.role : null;

        if (!role) {
          console.error("No role found. User might not be logged in.");
          return;
        }

        const response = await fetch(`https://ecoshopper-backend.onrender.com/admin/fn/users/${id}`, {
          headers: {
            'X-User-Role': role,
            'Content-Type': 'application/json'
          }
        });
        if (response.ok) {
          const user = await response.json();
          showSection('add-user');

          document.getElementById('user-name').value = user.name;
          document.getElementById('user-email').value = user.email;
          // Password field is left empty for security reasons
          document.getElementById('user-role').value = user.role;

          // Change form action to update
          const form = document.getElementById('user-form');
          form.dataset.id = id;
          form.dataset.action = 'update';

          // Change button text
          form.querySelector('button[type="submit"]').textContent = 'Update User';
        }
      } catch (error) {
        console.error('Error loading user for edit:', error);
      }
    }

    async function deleteUser(id) {
      if (confirm('Are you sure you want to delete this user?')) {
        try {
          const response = await fetch(`https://ecoshopper-backend.onrender.com/admin/fn/users/${id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            alert('User deleted successfully!');
            loadAdmins();
          } else {
            throw new Error('Failed to delete user');
          }
        } catch (error) {
          console.error('Error deleting user:', error);
          alert('Error deleting user. Please try again.');
        }
      }
    }
  </script>
</body>

</html>